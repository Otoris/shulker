'use strict';

const path = require('path');
const which = require('which');
const pathKey = require('path-key')();

function resolveCommandAttempt(parsed, withoutPathExt) ***REMOVED***
    const cwd = process.cwd();
    const hasCustomCwd = parsed.options.cwd != null;

    // If a custom `cwd` was specified, we need to change the process cwd
    // because `which` will do stat calls but does not support a custom cwd
    if (hasCustomCwd) ***REMOVED***
        try ***REMOVED***
            process.chdir(parsed.options.cwd);
        ***REMOVED*** catch (err) ***REMOVED***
            /* Empty */
        ***REMOVED***
    ***REMOVED***

    let resolved;

    try ***REMOVED***
        resolved = which.sync(parsed.command, ***REMOVED***
            path: (parsed.options.env || process.env)[pathKey],
            pathExt: withoutPathExt ? path.delimiter : undefined,
        ***REMOVED***);
    ***REMOVED*** catch (e) ***REMOVED***
        /* Empty */
    ***REMOVED*** finally ***REMOVED***
        process.chdir(cwd);
    ***REMOVED***

    // If we successfully resolved, ensure that an absolute path is returned
    // Note that when a custom `cwd` was used, we need to resolve to an absolute path based on it
    if (resolved) ***REMOVED***
        resolved = path.resolve(hasCustomCwd ? parsed.options.cwd : '', resolved);
    ***REMOVED***

    return resolved;
***REMOVED***

function resolveCommand(parsed) ***REMOVED***
    return resolveCommandAttempt(parsed) || resolveCommandAttempt(parsed, true);
***REMOVED***

module.exports = resolveCommand;
