import ***REMOVED*** Subject ***REMOVED*** from './Subject';
import ***REMOVED*** queue ***REMOVED*** from './scheduler/queue';
import ***REMOVED*** Subscription ***REMOVED*** from './Subscription';
import ***REMOVED*** ObserveOnSubscriber ***REMOVED*** from './operators/observeOn';
import ***REMOVED*** ObjectUnsubscribedError ***REMOVED*** from './util/ObjectUnsubscribedError';
import ***REMOVED*** SubjectSubscription ***REMOVED*** from './SubjectSubscription';
export class ReplaySubject extends Subject ***REMOVED***
    constructor(bufferSize = Number.POSITIVE_INFINITY, windowTime = Number.POSITIVE_INFINITY, scheduler) ***REMOVED***
        super();
        this.scheduler = scheduler;
        this._events = [];
        this._infiniteTimeWindow = false;
        this._bufferSize = bufferSize < 1 ? 1 : bufferSize;
        this._windowTime = windowTime < 1 ? 1 : windowTime;
        if (windowTime === Number.POSITIVE_INFINITY) ***REMOVED***
            this._infiniteTimeWindow = true;
            this.next = this.nextInfiniteTimeWindow;
        ***REMOVED***
        else ***REMOVED***
            this.next = this.nextTimeWindow;
        ***REMOVED***
    ***REMOVED***
    nextInfiniteTimeWindow(value) ***REMOVED***
        const _events = this._events;
        _events.push(value);
        if (_events.length > this._bufferSize) ***REMOVED***
            _events.shift();
        ***REMOVED***
        super.next(value);
    ***REMOVED***
    nextTimeWindow(value) ***REMOVED***
        this._events.push(new ReplayEvent(this._getNow(), value));
        this._trimBufferThenGetEvents();
        super.next(value);
    ***REMOVED***
    _subscribe(subscriber) ***REMOVED***
        const _infiniteTimeWindow = this._infiniteTimeWindow;
        const _events = _infiniteTimeWindow ? this._events : this._trimBufferThenGetEvents();
        const scheduler = this.scheduler;
        const len = _events.length;
        let subscription;
        if (this.closed) ***REMOVED***
            throw new ObjectUnsubscribedError();
        ***REMOVED***
        else if (this.isStopped || this.hasError) ***REMOVED***
            subscription = Subscription.EMPTY;
        ***REMOVED***
        else ***REMOVED***
            this.observers.push(subscriber);
            subscription = new SubjectSubscription(this, subscriber);
        ***REMOVED***
        if (scheduler) ***REMOVED***
            subscriber.add(subscriber = new ObserveOnSubscriber(subscriber, scheduler));
        ***REMOVED***
        if (_infiniteTimeWindow) ***REMOVED***
            for (let i = 0; i < len && !subscriber.closed; i++) ***REMOVED***
                subscriber.next(_events[i]);
            ***REMOVED***
        ***REMOVED***
        else ***REMOVED***
            for (let i = 0; i < len && !subscriber.closed; i++) ***REMOVED***
                subscriber.next(_events[i].value);
            ***REMOVED***
        ***REMOVED***
        if (this.hasError) ***REMOVED***
            subscriber.error(this.thrownError);
        ***REMOVED***
        else if (this.isStopped) ***REMOVED***
            subscriber.complete();
        ***REMOVED***
        return subscription;
    ***REMOVED***
    _getNow() ***REMOVED***
        return (this.scheduler || queue).now();
    ***REMOVED***
    _trimBufferThenGetEvents() ***REMOVED***
        const now = this._getNow();
        const _bufferSize = this._bufferSize;
        const _windowTime = this._windowTime;
        const _events = this._events;
        const eventsCount = _events.length;
        let spliceCount = 0;
        while (spliceCount < eventsCount) ***REMOVED***
            if ((now - _events[spliceCount].time) < _windowTime) ***REMOVED***
                break;
            ***REMOVED***
            spliceCount++;
        ***REMOVED***
        if (eventsCount > _bufferSize) ***REMOVED***
            spliceCount = Math.max(spliceCount, eventsCount - _bufferSize);
        ***REMOVED***
        if (spliceCount > 0) ***REMOVED***
            _events.splice(0, spliceCount);
        ***REMOVED***
        return _events;
    ***REMOVED***
***REMOVED***
class ReplayEvent ***REMOVED***
    constructor(time, value) ***REMOVED***
        this.time = time;
        this.value = value;
    ***REMOVED***
***REMOVED***
//# sourceMappingURL=ReplaySubject.js.map