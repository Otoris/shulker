import ***REMOVED*** isArray ***REMOVED*** from './util/isArray';
import ***REMOVED*** isObject ***REMOVED*** from './util/isObject';
import ***REMOVED*** isFunction ***REMOVED*** from './util/isFunction';
import ***REMOVED*** UnsubscriptionError ***REMOVED*** from './util/UnsubscriptionError';
export class Subscription ***REMOVED***
    constructor(unsubscribe) ***REMOVED***
        this.closed = false;
        this._parentOrParents = null;
        this._subscriptions = null;
        if (unsubscribe) ***REMOVED***
            this._unsubscribe = unsubscribe;
        ***REMOVED***
    ***REMOVED***
    unsubscribe() ***REMOVED***
        let errors;
        if (this.closed) ***REMOVED***
            return;
        ***REMOVED***
        let ***REMOVED*** _parentOrParents, _unsubscribe, _subscriptions ***REMOVED*** = this;
        this.closed = true;
        this._parentOrParents = null;
        this._subscriptions = null;
        if (_parentOrParents instanceof Subscription) ***REMOVED***
            _parentOrParents.remove(this);
        ***REMOVED***
        else if (_parentOrParents !== null) ***REMOVED***
            for (let index = 0; index < _parentOrParents.length; ++index) ***REMOVED***
                const parent = _parentOrParents[index];
                parent.remove(this);
            ***REMOVED***
        ***REMOVED***
        if (isFunction(_unsubscribe)) ***REMOVED***
            try ***REMOVED***
                _unsubscribe.call(this);
            ***REMOVED***
            catch (e) ***REMOVED***
                errors = e instanceof UnsubscriptionError ? flattenUnsubscriptionErrors(e.errors) : [e];
            ***REMOVED***
        ***REMOVED***
        if (isArray(_subscriptions)) ***REMOVED***
            let index = -1;
            let len = _subscriptions.length;
            while (++index < len) ***REMOVED***
                const sub = _subscriptions[index];
                if (isObject(sub)) ***REMOVED***
                    try ***REMOVED***
                        sub.unsubscribe();
                    ***REMOVED***
                    catch (e) ***REMOVED***
                        errors = errors || [];
                        if (e instanceof UnsubscriptionError) ***REMOVED***
                            errors = errors.concat(flattenUnsubscriptionErrors(e.errors));
                        ***REMOVED***
                        else ***REMOVED***
                            errors.push(e);
                        ***REMOVED***
                    ***REMOVED***
                ***REMOVED***
            ***REMOVED***
        ***REMOVED***
        if (errors) ***REMOVED***
            throw new UnsubscriptionError(errors);
        ***REMOVED***
    ***REMOVED***
    add(teardown) ***REMOVED***
        let subscription = teardown;
        if (!teardown) ***REMOVED***
            return Subscription.EMPTY;
        ***REMOVED***
        switch (typeof teardown) ***REMOVED***
            case 'function':
                subscription = new Subscription(teardown);
            case 'object':
                if (subscription === this || subscription.closed || typeof subscription.unsubscribe !== 'function') ***REMOVED***
                    return subscription;
                ***REMOVED***
                else if (this.closed) ***REMOVED***
                    subscription.unsubscribe();
                    return subscription;
                ***REMOVED***
                else if (!(subscription instanceof Subscription)) ***REMOVED***
                    const tmp = subscription;
                    subscription = new Subscription();
                    subscription._subscriptions = [tmp];
                ***REMOVED***
                break;
            default: ***REMOVED***
                throw new Error('unrecognized teardown ' + teardown + ' added to Subscription.');
            ***REMOVED***
        ***REMOVED***
        let ***REMOVED*** _parentOrParents ***REMOVED*** = subscription;
        if (_parentOrParents === null) ***REMOVED***
            subscription._parentOrParents = this;
        ***REMOVED***
        else if (_parentOrParents instanceof Subscription) ***REMOVED***
            if (_parentOrParents === this) ***REMOVED***
                return subscription;
            ***REMOVED***
            subscription._parentOrParents = [_parentOrParents, this];
        ***REMOVED***
        else if (_parentOrParents.indexOf(this) === -1) ***REMOVED***
            _parentOrParents.push(this);
        ***REMOVED***
        else ***REMOVED***
            return subscription;
        ***REMOVED***
        const subscriptions = this._subscriptions;
        if (subscriptions === null) ***REMOVED***
            this._subscriptions = [subscription];
        ***REMOVED***
        else ***REMOVED***
            subscriptions.push(subscription);
        ***REMOVED***
        return subscription;
    ***REMOVED***
    remove(subscription) ***REMOVED***
        const subscriptions = this._subscriptions;
        if (subscriptions) ***REMOVED***
            const subscriptionIndex = subscriptions.indexOf(subscription);
            if (subscriptionIndex !== -1) ***REMOVED***
                subscriptions.splice(subscriptionIndex, 1);
            ***REMOVED***
        ***REMOVED***
    ***REMOVED***
***REMOVED***
Subscription.EMPTY = (function (empty) ***REMOVED***
    empty.closed = true;
    return empty;
***REMOVED***(new Subscription()));
function flattenUnsubscriptionErrors(errors) ***REMOVED***
    return errors.reduce((errs, err) => errs.concat((err instanceof UnsubscriptionError) ? err.errors : err), []);
***REMOVED***
//# sourceMappingURL=Subscription.js.map