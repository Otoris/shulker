import ***REMOVED*** Action ***REMOVED*** from './Action';
export class AsyncAction extends Action ***REMOVED***
    constructor(scheduler, work) ***REMOVED***
        super(scheduler, work);
        this.scheduler = scheduler;
        this.work = work;
        this.pending = false;
    ***REMOVED***
    schedule(state, delay = 0) ***REMOVED***
        if (this.closed) ***REMOVED***
            return this;
        ***REMOVED***
        this.state = state;
        const id = this.id;
        const scheduler = this.scheduler;
        if (id != null) ***REMOVED***
            this.id = this.recycleAsyncId(scheduler, id, delay);
        ***REMOVED***
        this.pending = true;
        this.delay = delay;
        this.id = this.id || this.requestAsyncId(scheduler, this.id, delay);
        return this;
    ***REMOVED***
    requestAsyncId(scheduler, id, delay = 0) ***REMOVED***
        return setInterval(scheduler.flush.bind(scheduler, this), delay);
    ***REMOVED***
    recycleAsyncId(scheduler, id, delay = 0) ***REMOVED***
        if (delay !== null && this.delay === delay && this.pending === false) ***REMOVED***
            return id;
        ***REMOVED***
        clearInterval(id);
        return undefined;
    ***REMOVED***
    execute(state, delay) ***REMOVED***
        if (this.closed) ***REMOVED***
            return new Error('executing a cancelled action');
        ***REMOVED***
        this.pending = false;
        const error = this._execute(state, delay);
        if (error) ***REMOVED***
            return error;
        ***REMOVED***
        else if (this.pending === false && this.id != null) ***REMOVED***
            this.id = this.recycleAsyncId(this.scheduler, this.id, null);
        ***REMOVED***
    ***REMOVED***
    _execute(state, delay) ***REMOVED***
        let errored = false;
        let errorValue = undefined;
        try ***REMOVED***
            this.work(state);
        ***REMOVED***
        catch (e) ***REMOVED***
            errored = true;
            errorValue = !!e && e || new Error(e);
        ***REMOVED***
        if (errored) ***REMOVED***
            this.unsubscribe();
            return errorValue;
        ***REMOVED***
    ***REMOVED***
    _unsubscribe() ***REMOVED***
        const id = this.id;
        const scheduler = this.scheduler;
        const actions = scheduler.actions;
        const index = actions.indexOf(this);
        this.work = null;
        this.state = null;
        this.pending = false;
        this.scheduler = null;
        if (index !== -1) ***REMOVED***
            actions.splice(index, 1);
        ***REMOVED***
        if (id != null) ***REMOVED***
            this.id = this.recycleAsyncId(scheduler, id, null);
        ***REMOVED***
        this.delay = null;
    ***REMOVED***
***REMOVED***
//# sourceMappingURL=AsyncAction.js.map