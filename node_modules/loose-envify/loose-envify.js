'use strict';

var stream = require('stream');
var util = require('util');
var replace = require('./replace');

var jsonExtRe = /\.json$/;

module.exports = function(rootEnv) ***REMOVED***
  rootEnv = rootEnv || process.env;
  return function (file, trOpts) ***REMOVED***
    if (jsonExtRe.test(file)) ***REMOVED***
      return stream.PassThrough();
    ***REMOVED***
    var envs = trOpts ? [rootEnv, trOpts] : [rootEnv];
    return new LooseEnvify(envs);
  ***REMOVED***;
***REMOVED***;

function LooseEnvify(envs) ***REMOVED***
  stream.Transform.call(this);
  this._data = '';
  this._envs = envs;
***REMOVED***
util.inherits(LooseEnvify, stream.Transform);

LooseEnvify.prototype._transform = function(buf, enc, cb) ***REMOVED***
  this._data += buf;
  cb();
***REMOVED***;

LooseEnvify.prototype._flush = function(cb) ***REMOVED***
  var replaced = replace(this._data, this._envs);
  this.push(replaced);
  cb();
***REMOVED***;
