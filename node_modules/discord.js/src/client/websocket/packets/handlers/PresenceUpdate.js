const AbstractHandler = require('./AbstractHandler');
const Constants = require('../../../../util/Constants');
const Util = require('../../../../util/Util');

class PresenceUpdateHandler extends AbstractHandler ***REMOVED***
  handle(packet) ***REMOVED***
    const client = this.packetManager.client;
    const data = packet.d;
    let user = client.users.get(data.user.id);
    const guild = client.guilds.get(data.guild_id);

    // Step 1
    if (!user) ***REMOVED***
      if (data.user.username) ***REMOVED***
        user = client.dataManager.newUser(data.user);
      ***REMOVED*** else ***REMOVED***
        return;
      ***REMOVED***
    ***REMOVED***

    const oldUser = Util.cloneObject(user);
    user.patch(data.user);
    if (!user.equals(oldUser)) ***REMOVED***
      client.emit(Constants.Events.USER_UPDATE, oldUser, user);
    ***REMOVED***

    if (guild) ***REMOVED***
      let member = guild.members.get(user.id);
      if (!member && data.status !== 'offline') ***REMOVED***
        member = guild._addMember(***REMOVED***
          user,
          roles: data.roles,
          deaf: false,
          mute: false,
        ***REMOVED***, false);
        client.emit(Constants.Events.GUILD_MEMBER_AVAILABLE, member);
      ***REMOVED***
      if (member) ***REMOVED***
        if (client.listenerCount(Constants.Events.PRESENCE_UPDATE) === 0) ***REMOVED***
          guild._setPresence(user.id, data);
          return;
        ***REMOVED***
        const oldMember = Util.cloneObject(member);
        if (member.presence) ***REMOVED***
          oldMember.frozenPresence = Util.cloneObject(member.presence);
        ***REMOVED***
        guild._setPresence(user.id, data);
        client.emit(Constants.Events.PRESENCE_UPDATE, oldMember, member);
      ***REMOVED*** else ***REMOVED***
        guild._setPresence(user.id, data);
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***
***REMOVED***

/**
 * Emitted whenever a guild member's presence changes, or they change one of their details.
 * @event Client#presenceUpdate
 * @param ***REMOVED***GuildMember***REMOVED*** oldMember The member before the presence update
 * @param ***REMOVED***GuildMember***REMOVED*** newMember The member after the presence update
 */

/**
 * Emitted whenever a user's details (e.g. username) are changed.
 * @event Client#userUpdate
 * @param ***REMOVED***User***REMOVED*** oldUser The user before the update
 * @param ***REMOVED***User***REMOVED*** newUser The user after the update
 */

/**
 * Emitted whenever a member becomes available in a large guild.
 * @event Client#guildMemberAvailable
 * @param ***REMOVED***GuildMember***REMOVED*** member The member that became available
 */

module.exports = PresenceUpdateHandler;
