const Collection = require('../util/Collection');
const Emoji = require('./Emoji');
const ReactionEmoji = require('./ReactionEmoji');

/**
 * Represents a reaction to a message.
 */
class MessageReaction ***REMOVED***
  constructor(message, emoji, count, me) ***REMOVED***
    /**
     * The message that this reaction refers to
     * @type ***REMOVED***Message***REMOVED***
     */
    this.message = message;

    /**
     * Whether the client has given this reaction
     * @type ***REMOVED***boolean***REMOVED***
     */
    this.me = me;

    /**
     * The number of people that have given the same reaction
     * @type ***REMOVED***number***REMOVED***
     */
    this.count = count || 0;

    /**
     * The users that have given this reaction, mapped by their ID
     * @type ***REMOVED***Collection<Snowflake, User>***REMOVED***
     */
    this.users = new Collection();

    this._emoji = new ReactionEmoji(this, emoji);
  ***REMOVED***

  /**
   * The emoji of this reaction, either an Emoji object for known custom emojis, or a ReactionEmoji
   * object which has fewer properties. Whatever the prototype of the emoji, it will still have
   * `name`, `id`, `identifier` and `toString()`
   * @type ***REMOVED***Emoji|ReactionEmoji***REMOVED***
   * @readonly
   */
  get emoji() ***REMOVED***
    if (this._emoji instanceof Emoji) return this._emoji;
    // Check to see if the emoji has become known to the client
    if (this._emoji.id) ***REMOVED***
      const emojis = this.message.client.emojis;
      if (emojis.has(this._emoji.id)) ***REMOVED***
        const emoji = emojis.get(this._emoji.id);
        this._emoji = emoji;
        return emoji;
      ***REMOVED***
    ***REMOVED***
    return this._emoji;
  ***REMOVED***

  /**
   * Removes a user from this reaction.
   * @param ***REMOVED***UserResolvable***REMOVED*** [user=this.message.client.user] The user to remove the reaction of
   * @returns ***REMOVED***Promise<MessageReaction>***REMOVED***
   */
  remove(user = this.message.client.user) ***REMOVED***
    const message = this.message;
    const userID = this.message.client.resolver.resolveUserID(user);
    if (!userID) return Promise.reject(new Error('Couldn\'t resolve the user ID to remove from the reaction.'));
    return message.client.rest.methods.removeMessageReaction(
      message, this.emoji.identifier, userID
    );
  ***REMOVED***

  /**
   * Removes this reaction from the message
   * @returns ***REMOVED***Promise<MessageReaction>***REMOVED***
   */
  removeAll() ***REMOVED***
    const message = this.message;
    return message.client.rest.methods.removeMessageReactionEmoji(
      message, this.emoji.identifier
    );
  ***REMOVED***

  /**
   * Fetch all the users that gave this reaction. Resolves with a collection of users, mapped by their IDs.
   * @param ***REMOVED***number***REMOVED*** [limit=100] The maximum amount of users to fetch, defaults to 100
   * @param ***REMOVED***Object***REMOVED*** [options] Options to fetch users
   * @param ***REMOVED***Snowflake***REMOVED*** [options.before] Limit fetching users to those with an id lower than the supplied id
   * @param ***REMOVED***Snowflake***REMOVED*** [options.after] Limit fetching users to those with an id greater than the supplied id
   * @returns ***REMOVED***Promise<Collection<Snowflake, User>>***REMOVED***
   */
  fetchUsers(limit = 100, ***REMOVED*** after, before ***REMOVED*** = ***REMOVED******REMOVED***) ***REMOVED***
    const message = this.message;
    return message.client.rest.methods.getMessageReactionUsers(
      message, this.emoji.identifier, ***REMOVED*** after, before, limit ***REMOVED***
    ).then(data => ***REMOVED***
      const users = new Collection();
      for (const rawUser of data) ***REMOVED***
        const user = this.message.client.dataManager.newUser(rawUser);
        this.users.set(user.id, user);
        users.set(user.id, user);
      ***REMOVED***
      return users;
    ***REMOVED***);
  ***REMOVED***
***REMOVED***

module.exports = MessageReaction;
