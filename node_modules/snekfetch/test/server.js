const http = require('http');

const ref = require.main === module;

const server = http.createServer((req, res) => ***REMOVED***
  if (!ref)
    req.connection.unref();
  switch (req.url) ***REMOVED***
    case '/invalid-json':
      res.setHeader('Content-Type', 'application/json');
      res.end('***REMOVED*** "a": 1');
      break;
    case '/form-urlencoded':
      res.setHeader('Content-Type', 'application/x-www-form-urlencoded');
      res.end('test=1&hello=world');
      break;
    case '/echo': ***REMOVED***
      let body = '';
      req.on('data', (c) => ***REMOVED*** body += c; ***REMOVED***);
      req.on('end', () => ***REMOVED***
        res.end(body);
      ***REMOVED***);
      break;
    ***REMOVED***
    default:
      res.end();
      break;
  ***REMOVED***
***REMOVED***);

server.on('connection', (socket) => ***REMOVED***
  if (!ref)
    socket.unref();
***REMOVED***);

server.listen(0);

exports.port = server.address().port;

if (ref)
  console.log(exports.port); // eslint-disable-line no-console
