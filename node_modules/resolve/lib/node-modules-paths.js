var path = require('path');
var parse = path.parse || require('path-parse');

var getNodeModulesDirs = function getNodeModulesDirs(absoluteStart, modules) ***REMOVED***
    var prefix = '/';
    if ((/^([A-Za-z]:)/).test(absoluteStart)) ***REMOVED***
        prefix = '';
    ***REMOVED*** else if ((/^\\\\/).test(absoluteStart)) ***REMOVED***
        prefix = '\\\\';
    ***REMOVED***

    var paths = [absoluteStart];
    var parsed = parse(absoluteStart);
    while (parsed.dir !== paths[paths.length - 1]) ***REMOVED***
        paths.push(parsed.dir);
        parsed = parse(parsed.dir);
    ***REMOVED***

    return paths.reduce(function (dirs, aPath) ***REMOVED***
        return dirs.concat(modules.map(function (moduleDir) ***REMOVED***
            return path.resolve(prefix, aPath, moduleDir);
        ***REMOVED***));
    ***REMOVED***, []);
***REMOVED***;

module.exports = function nodeModulesPaths(start, opts, request) ***REMOVED***
    var modules = opts && opts.moduleDirectory
        ? [].concat(opts.moduleDirectory)
        : ['node_modules'];

    if (opts && typeof opts.paths === 'function') ***REMOVED***
        return opts.paths(
            request,
            start,
            function () ***REMOVED*** return getNodeModulesDirs(start, modules); ***REMOVED***,
            opts
        );
    ***REMOVED***

    var dirs = getNodeModulesDirs(start, modules);
    return opts && opts.paths ? dirs.concat(opts.paths) : dirs;
***REMOVED***;
