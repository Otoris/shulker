var path = require('path');
var test = require('tape');
var resolve = require('../');

test('async foo', function (t) ***REMOVED***
    t.plan(12);
    var dir = path.join(__dirname, 'resolver');

    resolve('./foo', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg && pkg.name, 'resolve');
    ***REMOVED***);

    resolve('./foo.js', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg && pkg.name, 'resolve');
    ***REMOVED***);

    resolve('./foo', ***REMOVED*** basedir: dir, 'package': ***REMOVED*** main: 'resolver' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg && pkg.main, 'resolver');
    ***REMOVED***);

    resolve('./foo.js', ***REMOVED*** basedir: dir, 'package': ***REMOVED*** main: 'resolver' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg.main, 'resolver');
    ***REMOVED***);

    resolve('./foo', ***REMOVED*** basedir: dir, filename: path.join(dir, 'baz.js') ***REMOVED***, function (err, res) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
    ***REMOVED***);

    resolve('foo', ***REMOVED*** basedir: dir ***REMOVED***, function (err) ***REMOVED***
        t.equal(err.message, "Cannot find module 'foo' from '" + path.resolve(dir) + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
    ***REMOVED***);

    // Test that filename is reported as the "from" value when passed.
    resolve('foo', ***REMOVED*** basedir: dir, filename: path.join(dir, 'baz.js') ***REMOVED***, function (err) ***REMOVED***
        t.equal(err.message, "Cannot find module 'foo' from '" + path.join(dir, 'baz.js') + "'");
    ***REMOVED***);
***REMOVED***);

test('bar', function (t) ***REMOVED***
    t.plan(6);
    var dir = path.join(__dirname, 'resolver');

    resolve('foo', ***REMOVED*** basedir: dir + '/bar' ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'bar/node_modules/foo/index.js'));
        t.equal(pkg, undefined);
    ***REMOVED***);

    resolve('foo', ***REMOVED*** basedir: dir + '/bar' ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'bar/node_modules/foo/index.js'));
        t.equal(pkg, undefined);
    ***REMOVED***);

    resolve('foo', ***REMOVED*** basedir: dir + '/bar', 'package': ***REMOVED*** main: 'bar' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'bar/node_modules/foo/index.js'));
        t.equal(pkg.main, 'bar');
    ***REMOVED***);
***REMOVED***);

test('baz', function (t) ***REMOVED***
    t.plan(4);
    var dir = path.join(__dirname, 'resolver');

    resolve('./baz', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'baz/quux.js'));
        t.equal(pkg.main, 'quux.js');
    ***REMOVED***);

    resolve('./baz', ***REMOVED*** basedir: dir, 'package': ***REMOVED*** main: 'resolver' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'baz/quux.js'));
        t.equal(pkg.main, 'quux.js');
    ***REMOVED***);
***REMOVED***);

test('biz', function (t) ***REMOVED***
    t.plan(24);
    var dir = path.join(__dirname, 'resolver/biz/node_modules');

    resolve('./grux', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg, undefined);
    ***REMOVED***);

    resolve('./grux', ***REMOVED*** basedir: dir, 'package': ***REMOVED*** main: 'biz' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg.main, 'biz');
    ***REMOVED***);

    resolve('./garply', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    ***REMOVED***);

    resolve('./garply', ***REMOVED*** basedir: dir, 'package': ***REMOVED*** main: 'biz' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    ***REMOVED***);

    resolve('tiv', ***REMOVED*** basedir: dir + '/grux' ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg, undefined);
    ***REMOVED***);

    resolve('tiv', ***REMOVED*** basedir: dir + '/grux', 'package': ***REMOVED*** main: 'grux' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg.main, 'grux');
    ***REMOVED***);

    resolve('tiv', ***REMOVED*** basedir: dir + '/garply' ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg, undefined);
    ***REMOVED***);

    resolve('tiv', ***REMOVED*** basedir: dir + '/garply', 'package': ***REMOVED*** main: './lib' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg.main, './lib');
    ***REMOVED***);

    resolve('grux', ***REMOVED*** basedir: dir + '/tiv' ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg, undefined);
    ***REMOVED***);

    resolve('grux', ***REMOVED*** basedir: dir + '/tiv', 'package': ***REMOVED*** main: 'tiv' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg.main, 'tiv');
    ***REMOVED***);

    resolve('garply', ***REMOVED*** basedir: dir + '/tiv' ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    ***REMOVED***);

    resolve('garply', ***REMOVED*** basedir: dir + '/tiv', 'package': ***REMOVED*** main: 'tiv' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    ***REMOVED***);
***REMOVED***);

test('quux', function (t) ***REMOVED***
    t.plan(2);
    var dir = path.join(__dirname, 'resolver/quux');

    resolve('./foo', ***REMOVED*** basedir: dir, 'package': ***REMOVED*** main: 'quux' ***REMOVED*** ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo/index.js'));
        t.equal(pkg.main, 'quux');
    ***REMOVED***);
***REMOVED***);

test('normalize', function (t) ***REMOVED***
    t.plan(2);
    var dir = path.join(__dirname, 'resolver/biz/node_modules/grux');

    resolve('../grux', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'index.js'));
        t.equal(pkg, undefined);
    ***REMOVED***);
***REMOVED***);

test('cup', function (t) ***REMOVED***
    t.plan(5);
    var dir = path.join(__dirname, 'resolver');

    resolve('./cup', ***REMOVED*** basedir: dir, extensions: ['.js', '.coffee'] ***REMOVED***, function (err, res) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'cup.coffee'));
    ***REMOVED***);

    resolve('./cup.coffee', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'cup.coffee'));
    ***REMOVED***);

    resolve('./cup', ***REMOVED*** basedir: dir, extensions: ['.js'] ***REMOVED***, function (err, res) ***REMOVED***
        t.equal(err.message, "Cannot find module './cup' from '" + path.resolve(dir) + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
    ***REMOVED***);

    // Test that filename is reported as the "from" value when passed.
    resolve('./cup', ***REMOVED*** basedir: dir, extensions: ['.js'], filename: path.join(dir, 'cupboard.js') ***REMOVED***, function (err, res) ***REMOVED***
        t.equal(err.message, "Cannot find module './cup' from '" + path.join(dir, 'cupboard.js') + "'");
    ***REMOVED***);
***REMOVED***);

test('mug', function (t) ***REMOVED***
    t.plan(3);
    var dir = path.join(__dirname, 'resolver');

    resolve('./mug', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'mug.js'));
    ***REMOVED***);

    resolve('./mug', ***REMOVED*** basedir: dir, extensions: ['.coffee', '.js'] ***REMOVED***, function (err, res) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, '/mug.coffee'));
    ***REMOVED***);

    resolve('./mug', ***REMOVED*** basedir: dir, extensions: ['.js', '.coffee'] ***REMOVED***, function (err, res) ***REMOVED***
        t.equal(res, path.join(dir, '/mug.js'));
    ***REMOVED***);
***REMOVED***);

test('other path', function (t) ***REMOVED***
    t.plan(6);
    var resolverDir = path.join(__dirname, 'resolver');
    var dir = path.join(resolverDir, 'bar');
    var otherDir = path.join(resolverDir, 'other_path');

    resolve('root', ***REMOVED*** basedir: dir, paths: [otherDir] ***REMOVED***, function (err, res) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(resolverDir, 'other_path/root.js'));
    ***REMOVED***);

    resolve('lib/other-lib', ***REMOVED*** basedir: dir, paths: [otherDir] ***REMOVED***, function (err, res) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(resolverDir, 'other_path/lib/other-lib.js'));
    ***REMOVED***);

    resolve('root', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res) ***REMOVED***
        t.equal(err.message, "Cannot find module 'root' from '" + path.resolve(dir) + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
    ***REMOVED***);

    resolve('zzz', ***REMOVED*** basedir: dir, paths: [otherDir] ***REMOVED***, function (err, res) ***REMOVED***
        t.equal(err.message, "Cannot find module 'zzz' from '" + path.resolve(dir) + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
    ***REMOVED***);
***REMOVED***);

test('path iterator', function (t) ***REMOVED***
    t.plan(2);

    var resolverDir = path.join(__dirname, 'resolver');

    var exactIterator = function (x, start, getPackageCandidates, opts) ***REMOVED***
        return [path.join(resolverDir, x)];
    ***REMOVED***;

    resolve('baz', ***REMOVED*** packageIterator: exactIterator ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(resolverDir, 'baz/quux.js'));
        t.equal(pkg && pkg.name, 'baz');
    ***REMOVED***);
***REMOVED***);

test('incorrect main', function (t) ***REMOVED***
    t.plan(1);

    var resolverDir = path.join(__dirname, 'resolver');
    var dir = path.join(resolverDir, 'incorrect_main');

    resolve('./incorrect_main', ***REMOVED*** basedir: resolverDir ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'index.js'));
    ***REMOVED***);
***REMOVED***);

test('without basedir', function (t) ***REMOVED***
    t.plan(1);

    var dir = path.join(__dirname, 'resolver/without_basedir');
    var tester = require(path.join(dir, 'main.js'));

    tester(t, function (err, res, pkg) ***REMOVED***
        if (err) ***REMOVED***
            t.fail(err);
        ***REMOVED*** else ***REMOVED***
            t.equal(res, path.join(dir, 'node_modules/mymodule.js'));
        ***REMOVED***
    ***REMOVED***);
***REMOVED***);

test('#52 - incorrectly resolves module-paths like "./someFolder/" when there is a file of the same name', function (t) ***REMOVED***
    t.plan(2);

    var dir = path.join(__dirname, 'resolver');

    resolve('./foo', ***REMOVED*** basedir: path.join(dir, 'same_names') ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'same_names/foo.js'));
    ***REMOVED***);

    resolve('./foo/', ***REMOVED*** basedir: path.join(dir, 'same_names') ***REMOVED***, function (err, res, pkg) ***REMOVED***
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'same_names/foo/index.js'));
    ***REMOVED***);
***REMOVED***);

test('async: #121 - treating an existing file as a dir when no basedir', function (t) ***REMOVED***
    var testFile = path.basename(__filename);

    t.test('sanity check', function (st) ***REMOVED***
        st.plan(1);
        resolve('./' + testFile, function (err, res, pkg) ***REMOVED***
            if (err) t.fail(err);
            st.equal(res, __filename, 'sanity check');
        ***REMOVED***);
    ***REMOVED***);

    t.test('with a fake directory', function (st) ***REMOVED***
        st.plan(4);

        resolve('./' + testFile + '/blah', function (err, res, pkg) ***REMOVED***
            st.ok(err, 'there is an error');
            st.notOk(res, 'no result');

            st.equal(err && err.code, 'MODULE_NOT_FOUND', 'error code matches require.resolve');
            st.equal(
                err && err.message,
                'Cannot find module \'./' + testFile + '/blah\' from \'' + __dirname + '\'',
                'can not find nonexistent module'
            );
            st.end();
        ***REMOVED***);
    ***REMOVED***);

    t.end();
***REMOVED***);

test('async dot main', function (t) ***REMOVED***
    var start = new Date();
    t.plan(3);
    resolve('./resolver/dot_main', function (err, ret) ***REMOVED***
        t.notOk(err);
        t.equal(ret, path.join(__dirname, 'resolver/dot_main/index.js'));
        t.ok(new Date() - start < 50, 'resolve.sync timedout');
        t.end();
    ***REMOVED***);
***REMOVED***);

test('async dot slash main', function (t) ***REMOVED***
    var start = new Date();
    t.plan(3);
    resolve('./resolver/dot_slash_main', function (err, ret) ***REMOVED***
        t.notOk(err);
        t.equal(ret, path.join(__dirname, 'resolver/dot_slash_main/index.js'));
        t.ok(new Date() - start < 50, 'resolve.sync timedout');
        t.end();
    ***REMOVED***);
***REMOVED***);

test('not a directory', function (t) ***REMOVED***
    t.plan(6);
    var path = './foo';
    resolve(path, ***REMOVED*** basedir: __filename ***REMOVED***, function (err, res, pkg) ***REMOVED***
        t.ok(err, 'a non-directory errors');
        t.equal(arguments.length, 1);
        t.equal(res, undefined);
        t.equal(pkg, undefined);

        t.equal(err && err.message, 'Cannot find module \'' + path + '\' from \'' + __filename + '\'');
        t.equal(err && err.code, 'MODULE_NOT_FOUND');
    ***REMOVED***);
***REMOVED***);

test('non-string "main" field in package.json', function (t) ***REMOVED***
    t.plan(5);

    var dir = path.join(__dirname, 'resolver');
    resolve('./invalid_main', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res, pkg) ***REMOVED***
        t.ok(err, 'errors on non-string main');
        t.equal(err.message, 'package “invalid main” `main` must be a string');
        t.equal(err.code, 'INVALID_PACKAGE_MAIN');
        t.equal(res, undefined, 'res is undefined');
        t.equal(pkg, undefined, 'pkg is undefined');
    ***REMOVED***);
***REMOVED***);

test('non-string "main" field in package.json', function (t) ***REMOVED***
    t.plan(5);

    var dir = path.join(__dirname, 'resolver');
    resolve('./invalid_main', ***REMOVED*** basedir: dir ***REMOVED***, function (err, res, pkg) ***REMOVED***
        t.ok(err, 'errors on non-string main');
        t.equal(err.message, 'package “invalid main” `main` must be a string');
        t.equal(err.code, 'INVALID_PACKAGE_MAIN');
        t.equal(res, undefined, 'res is undefined');
        t.equal(pkg, undefined, 'pkg is undefined');
    ***REMOVED***);
***REMOVED***);

test('browser field in package.json', function (t) ***REMOVED***
    t.plan(3);

    var dir = path.join(__dirname, 'resolver');
    resolve(
        './browser_field',
        ***REMOVED***
            basedir: dir,
            packageFilter: function packageFilter(pkg) ***REMOVED***
                if (pkg.browser) ***REMOVED***
                    pkg.main = pkg.browser; // eslint-disable-line no-param-reassign
                    delete pkg.browser; // eslint-disable-line no-param-reassign
                ***REMOVED***
                return pkg;
            ***REMOVED***
        ***REMOVED***,
        function (err, res, pkg) ***REMOVED***
            if (err) t.fail(err);
            t.equal(res, path.join(dir, 'browser_field', 'b.js'));
            t.equal(pkg && pkg.main, 'b');
            t.equal(pkg && pkg.browser, undefined);
        ***REMOVED***
    );
***REMOVED***);
