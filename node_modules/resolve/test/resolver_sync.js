var path = require('path');
var test = require('tape');
var resolve = require('../');

test('foo', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver');

    t.equal(
        resolve.sync('./foo', ***REMOVED*** basedir: dir ***REMOVED***),
        path.join(dir, 'foo.js')
    );

    t.equal(
        resolve.sync('./foo.js', ***REMOVED*** basedir: dir ***REMOVED***),
        path.join(dir, 'foo.js')
    );

    t.equal(
        resolve.sync('./foo.js', ***REMOVED*** basedir: dir, filename: path.join(dir, 'bar.js') ***REMOVED***),
        path.join(dir, 'foo.js')
    );

    t.throws(function () ***REMOVED***
        resolve.sync('foo', ***REMOVED*** basedir: dir ***REMOVED***);
    ***REMOVED***);

    // Test that filename is reported as the "from" value when passed.
    t.throws(
        function () ***REMOVED***
            resolve.sync('foo', ***REMOVED*** basedir: dir, filename: path.join(dir, 'bar.js') ***REMOVED***);
        ***REMOVED***,
        ***REMOVED***
            name: 'Error',
            message: "Cannot find module 'foo' from '" + path.join(dir, 'bar.js') + "'"
        ***REMOVED***
    );

    t.end();
***REMOVED***);

test('bar', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver');

    t.equal(
        resolve.sync('foo', ***REMOVED*** basedir: path.join(dir, 'bar') ***REMOVED***),
        path.join(dir, 'bar/node_modules/foo/index.js')
    );
    t.end();
***REMOVED***);

test('baz', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver');

    t.equal(
        resolve.sync('./baz', ***REMOVED*** basedir: dir ***REMOVED***),
        path.join(dir, 'baz/quux.js')
    );
    t.end();
***REMOVED***);

test('biz', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver/biz/node_modules');
    t.equal(
        resolve.sync('./grux', ***REMOVED*** basedir: dir ***REMOVED***),
        path.join(dir, 'grux/index.js')
    );

    t.equal(
        resolve.sync('tiv', ***REMOVED*** basedir: path.join(dir, 'grux') ***REMOVED***),
        path.join(dir, 'tiv/index.js')
    );

    t.equal(
        resolve.sync('grux', ***REMOVED*** basedir: path.join(dir, 'tiv') ***REMOVED***),
        path.join(dir, 'grux/index.js')
    );
    t.end();
***REMOVED***);

test('normalize', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver/biz/node_modules/grux');
    t.equal(
        resolve.sync('../grux', ***REMOVED*** basedir: dir ***REMOVED***),
        path.join(dir, 'index.js')
    );
    t.end();
***REMOVED***);

test('cup', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver');
    t.equal(
        resolve.sync('./cup', ***REMOVED***
            basedir: dir,
            extensions: ['.js', '.coffee']
        ***REMOVED***),
        path.join(dir, 'cup.coffee')
    );

    t.equal(
        resolve.sync('./cup.coffee', ***REMOVED*** basedir: dir ***REMOVED***),
        path.join(dir, 'cup.coffee')
    );

    t.throws(function () ***REMOVED***
        resolve.sync('./cup', ***REMOVED***
            basedir: dir,
            extensions: ['.js']
        ***REMOVED***);
    ***REMOVED***);

    t.end();
***REMOVED***);

test('mug', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver');
    t.equal(
        resolve.sync('./mug', ***REMOVED*** basedir: dir ***REMOVED***),
        path.join(dir, 'mug.js')
    );

    t.equal(
        resolve.sync('./mug', ***REMOVED***
            basedir: dir,
            extensions: ['.coffee', '.js']
        ***REMOVED***),
        path.join(dir, 'mug.coffee')
    );

    t.equal(
        resolve.sync('./mug', ***REMOVED***
            basedir: dir,
            extensions: ['.js', '.coffee']
        ***REMOVED***),
        path.join(dir, 'mug.js')
    );

    t.end();
***REMOVED***);

test('other path', function (t) ***REMOVED***
    var resolverDir = path.join(__dirname, 'resolver');
    var dir = path.join(resolverDir, 'bar');
    var otherDir = path.join(resolverDir, 'other_path');

    t.equal(
        resolve.sync('root', ***REMOVED***
            basedir: dir,
            paths: [otherDir]
        ***REMOVED***),
        path.join(resolverDir, 'other_path/root.js')
    );

    t.equal(
        resolve.sync('lib/other-lib', ***REMOVED***
            basedir: dir,
            paths: [otherDir]
        ***REMOVED***),
        path.join(resolverDir, 'other_path/lib/other-lib.js')
    );

    t.throws(function () ***REMOVED***
        resolve.sync('root', ***REMOVED*** basedir: dir ***REMOVED***);
    ***REMOVED***);

    t.throws(function () ***REMOVED***
        resolve.sync('zzz', ***REMOVED***
            basedir: dir,
            paths: [otherDir]
        ***REMOVED***);
    ***REMOVED***);

    t.end();
***REMOVED***);

test('path iterator', function (t) ***REMOVED***
    var resolverDir = path.join(__dirname, 'resolver');

    var exactIterator = function (x, start, getPackageCandidates, opts) ***REMOVED***
        return [path.join(resolverDir, x)];
    ***REMOVED***;

    t.equal(
        resolve.sync('baz', ***REMOVED*** packageIterator: exactIterator ***REMOVED***),
        path.join(resolverDir, 'baz/quux.js')
    );

    t.end();
***REMOVED***);

test('incorrect main', function (t) ***REMOVED***
    var resolverDir = path.join(__dirname, 'resolver');
    var dir = path.join(resolverDir, 'incorrect_main');

    t.equal(
        resolve.sync('./incorrect_main', ***REMOVED*** basedir: resolverDir ***REMOVED***),
        path.join(dir, 'index.js')
    );

    t.end();
***REMOVED***);

var stubStatSync = function stubStatSync(fn) ***REMOVED***
    var fs = require('fs');
    var statSync = fs.statSync;
    try ***REMOVED***
        fs.statSync = function () ***REMOVED***
            throw new EvalError('Unknown Error');
        ***REMOVED***;
        return fn();
    ***REMOVED*** finally ***REMOVED***
        fs.statSync = statSync;
    ***REMOVED***
***REMOVED***;

test('#79 - re-throw non ENOENT errors from stat', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver');

    stubStatSync(function () ***REMOVED***
        t.throws(function () ***REMOVED***
            resolve.sync('foo', ***REMOVED*** basedir: dir ***REMOVED***);
        ***REMOVED***, /Unknown Error/);
    ***REMOVED***);

    t.end();
***REMOVED***);

test('#52 - incorrectly resolves module-paths like "./someFolder/" when there is a file of the same name', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver');

    t.equal(
        resolve.sync('./foo', ***REMOVED*** basedir: path.join(dir, 'same_names') ***REMOVED***),
        path.join(dir, 'same_names/foo.js')
    );
    t.equal(
        resolve.sync('./foo/', ***REMOVED*** basedir: path.join(dir, 'same_names') ***REMOVED***),
        path.join(dir, 'same_names/foo/index.js')
    );
    t.end();
***REMOVED***);

test('sync: #121 - treating an existing file as a dir when no basedir', function (t) ***REMOVED***
    var testFile = path.basename(__filename);

    t.test('sanity check', function (st) ***REMOVED***
        st.equal(
            resolve.sync('./' + testFile),
            __filename,
            'sanity check'
        );
        st.end();
    ***REMOVED***);

    t.test('with a fake directory', function (st) ***REMOVED***
        function run() ***REMOVED*** return resolve.sync('./' + testFile + '/blah'); ***REMOVED***

        st.throws(run, 'throws an error');

        try ***REMOVED***
            run();
        ***REMOVED*** catch (e) ***REMOVED***
            st.equal(e.code, 'MODULE_NOT_FOUND', 'error code matches require.resolve');
            st.equal(
                e.message,
                'Cannot find module \'./' + testFile + '/blah\' from \'' + __dirname + '\'',
                'can not find nonexistent module'
            );
        ***REMOVED***

        st.end();
    ***REMOVED***);

    t.end();
***REMOVED***);

test('sync dot main', function (t) ***REMOVED***
    var start = new Date();
    t.equal(resolve.sync('./resolver/dot_main'), path.join(__dirname, 'resolver/dot_main/index.js'));
    t.ok(new Date() - start < 50, 'resolve.sync timedout');
    t.end();
***REMOVED***);

test('sync dot slash main', function (t) ***REMOVED***
    var start = new Date();
    t.equal(resolve.sync('./resolver/dot_slash_main'), path.join(__dirname, 'resolver/dot_slash_main/index.js'));
    t.ok(new Date() - start < 50, 'resolve.sync timedout');
    t.end();
***REMOVED***);

test('not a directory', function (t) ***REMOVED***
    var path = './foo';
    try ***REMOVED***
        resolve.sync(path, ***REMOVED*** basedir: __filename ***REMOVED***);
        t.fail();
    ***REMOVED*** catch (err) ***REMOVED***
        t.ok(err, 'a non-directory errors');
        t.equal(err && err.message, 'Cannot find module \'' + path + "' from '" + __filename + "'");
        t.equal(err && err.code, 'MODULE_NOT_FOUND');
    ***REMOVED***
    t.end();
***REMOVED***);

test('non-string "main" field in package.json', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver');
    try ***REMOVED***
        var result = resolve.sync('./invalid_main', ***REMOVED*** basedir: dir ***REMOVED***);
        t.equal(result, undefined, 'result should not exist');
        t.fail('should not get here');
    ***REMOVED*** catch (err) ***REMOVED***
        t.ok(err, 'errors on non-string main');
        t.equal(err.message, 'package “invalid main” `main` must be a string');
        t.equal(err.code, 'INVALID_PACKAGE_MAIN');
    ***REMOVED***
    t.end();
***REMOVED***);

test('non-string "main" field in package.json', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver');
    try ***REMOVED***
        var result = resolve.sync('./invalid_main', ***REMOVED*** basedir: dir ***REMOVED***);
        t.equal(result, undefined, 'result should not exist');
        t.fail('should not get here');
    ***REMOVED*** catch (err) ***REMOVED***
        t.ok(err, 'errors on non-string main');
        t.equal(err.message, 'package “invalid main” `main` must be a string');
        t.equal(err.code, 'INVALID_PACKAGE_MAIN');
    ***REMOVED***
    t.end();
***REMOVED***);

test('browser field in package.json', function (t) ***REMOVED***
    var dir = path.join(__dirname, 'resolver');
    var res = resolve.sync('./browser_field', ***REMOVED***
        basedir: dir,
        packageFilter: function packageFilter(pkg) ***REMOVED***
            if (pkg.browser) ***REMOVED***
                pkg.main = pkg.browser; // eslint-disable-line no-param-reassign
                delete pkg.browser; // eslint-disable-line no-param-reassign
            ***REMOVED***
            return pkg;
        ***REMOVED***
    ***REMOVED***);
    t.equal(res, path.join(dir, 'browser_field', 'b.js'));
    t.end();
***REMOVED***);
