/**
 * @fileoverview Tools for obtaining SourceCode objects.
 * @author Ian VanSchooten
 */

"use strict";

//------------------------------------------------------------------------------
// Requirements
//------------------------------------------------------------------------------

const ***REMOVED*** CLIEngine ***REMOVED*** = require("../cli-engine");

/*
 * This is used for:
 *
 * 1. Enumerate target file because we have not expose such a API on `CLIEngine`
 *    (https://github.com/eslint/eslint/issues/11222).
 * 2. Create `SourceCode` instances. Because we don't have any function which
 *    instantiate `SourceCode` so it needs to take the created `SourceCode`
 *    instance out after linting.
 *
 * TODO1: Expose the API that enumerates target files.
 * TODO2: Extract the creation logic of `SourceCode` from `Linter` class.
 */
const ***REMOVED*** getCLIEngineInternalSlots ***REMOVED*** = require("../cli-engine/cli-engine"); // eslint-disable-line no-restricted-modules

const debug = require("debug")("eslint:source-code-utils");

//------------------------------------------------------------------------------
// Helpers
//------------------------------------------------------------------------------

/**
 * Get the SourceCode object for a single file
 * @param   ***REMOVED***string***REMOVED***     filename The fully resolved filename to get SourceCode from.
 * @param   ***REMOVED***Object***REMOVED***     engine  A CLIEngine.
 * @returns ***REMOVED***Array***REMOVED***               Array of the SourceCode object representing the file
 *                                and fatal error message.
 */
function getSourceCodeOfFile(filename, engine) ***REMOVED***
    debug("getting sourceCode of", filename);
    const results = engine.executeOnFiles([filename]);

    if (results && results.results[0] && results.results[0].messages[0] && results.results[0].messages[0].fatal) ***REMOVED***
        const msg = results.results[0].messages[0];

        throw new Error(`($***REMOVED***filename***REMOVED***:$***REMOVED***msg.line***REMOVED***:$***REMOVED***msg.column***REMOVED***) $***REMOVED***msg.message***REMOVED***`);
    ***REMOVED***

    // TODO: extract the logic that creates source code objects to `SourceCode#parse(text, options)` or something like.
    const ***REMOVED*** linter ***REMOVED*** = getCLIEngineInternalSlots(engine);
    const sourceCode = linter.getSourceCode();

    return sourceCode;
***REMOVED***

//------------------------------------------------------------------------------
// Public Interface
//------------------------------------------------------------------------------


/**
 * This callback is used to measure execution status in a progress bar
 * @callback progressCallback
 * @param ***REMOVED***number***REMOVED*** The total number of times the callback will be called.
 */

/**
 * Gets the SourceCode of a single file, or set of files.
 * @param ***REMOVED***string[]|string***REMOVED*** patterns A filename, directory name, or glob, or an array of them
 * @param ***REMOVED***Object***REMOVED*** options A CLIEngine options object. If not provided, the default cli options will be used.
 * @param ***REMOVED***progressCallback***REMOVED*** callback Callback for reporting execution status
 * @returns ***REMOVED***Object***REMOVED*** The SourceCode of all processed files.
 */
function getSourceCodeOfFiles(patterns, options, callback) ***REMOVED***
    const sourceCodes = ***REMOVED******REMOVED***;
    const globPatternsList = typeof patterns === "string" ? [patterns] : patterns;
    const engine = new CLIEngine(***REMOVED*** ...options, rules: ***REMOVED******REMOVED*** ***REMOVED***);

    // TODO: make file iteration as a public API and use it.
    const ***REMOVED*** fileEnumerator ***REMOVED*** = getCLIEngineInternalSlots(engine);
    const filenames =
        Array.from(fileEnumerator.iterateFiles(globPatternsList))
            .filter(entry => !entry.ignored)
            .map(entry => entry.filePath);

    if (filenames.length === 0) ***REMOVED***
        debug(`Did not find any files matching pattern(s): $***REMOVED***globPatternsList***REMOVED***`);
    ***REMOVED***

    filenames.forEach(filename => ***REMOVED***
        const sourceCode = getSourceCodeOfFile(filename, engine);

        if (sourceCode) ***REMOVED***
            debug("got sourceCode of", filename);
            sourceCodes[filename] = sourceCode;
        ***REMOVED***
        if (callback) ***REMOVED***
            callback(filenames.length); // eslint-disable-line callback-return
        ***REMOVED***
    ***REMOVED***);

    return sourceCodes;
***REMOVED***

module.exports = ***REMOVED***
    getSourceCodeOfFiles
***REMOVED***;
