#!/usr/bin/env node

/**
 * @fileoverview Main CLI that is run via the eslint command.
 * @author Nicholas C. Zakas
 */

/* eslint no-console:off */

"use strict";

// to use V8's code cache to speed up instantiation time
require("v8-compile-cache");

//------------------------------------------------------------------------------
// Helpers
//------------------------------------------------------------------------------

const useStdIn = (process.argv.indexOf("--stdin") > -1),
    init = (process.argv.indexOf("--init") > -1),
    debug = (process.argv.indexOf("--debug") > -1);

// must do this initialization *before* other requires in order to work
if (debug) ***REMOVED***
    require("debug").enable("eslint:*,-eslint:code-path");
***REMOVED***

//------------------------------------------------------------------------------
// Requirements
//------------------------------------------------------------------------------

// now we can safely include the other modules that use debug
const cli = require("../lib/cli"),
    path = require("path"),
    fs = require("fs");

//------------------------------------------------------------------------------
// Execution
//------------------------------------------------------------------------------

process.once("uncaughtException", err => ***REMOVED***

    // lazy load
    const lodash = require("lodash");

    if (typeof err.messageTemplate === "string" && err.messageTemplate.length > 0) ***REMOVED***
        const template = lodash.template(fs.readFileSync(path.resolve(__dirname, `../messages/$***REMOVED***err.messageTemplate***REMOVED***.txt`), "utf-8"));
        const pkg = require("../package.json");

        console.error("\nOops! Something went wrong! :(");
        console.error(`\nESLint: $***REMOVED***pkg.version***REMOVED***.\n\n$***REMOVED***template(err.messageData || ***REMOVED******REMOVED***)***REMOVED***`);
    ***REMOVED*** else ***REMOVED***

        console.error(err.stack);
    ***REMOVED***

    process.exitCode = 2;
***REMOVED***);

if (useStdIn) ***REMOVED***

    /*
     * Note: `process.stdin.fd` is not used here due to https://github.com/nodejs/node/issues/7439.
     * Accessing the `process.stdin` property seems to modify the behavior of file descriptor 0, resulting
     * in an error when stdin is piped in asynchronously.
     */
    const STDIN_FILE_DESCRIPTOR = 0;

    process.exitCode = cli.execute(process.argv, fs.readFileSync(STDIN_FILE_DESCRIPTOR, "utf8"));
***REMOVED*** else if (init) ***REMOVED***
    const configInit = require("../lib/init/config-initializer");

    configInit.initializeConfig().then(() => ***REMOVED***
        process.exitCode = 0;
    ***REMOVED***).catch(err => ***REMOVED***
        process.exitCode = 1;
        console.error(err.message);
        console.error(err.stack);
    ***REMOVED***);
***REMOVED*** else ***REMOVED***
    process.exitCode = cli.execute(process.argv);
***REMOVED***
