'use strict';
/**
 * `list` type prompt
 */

var _ = require('lodash');
var chalk = require('chalk');
var cliCursor = require('cli-cursor');
var figures = require('figures');
var ***REMOVED*** map, takeUntil ***REMOVED*** = require('rxjs/operators');
var Base = require('./base');
var observe = require('../utils/events');
var Paginator = require('../utils/paginator');

class CheckboxPrompt extends Base ***REMOVED***
  constructor(questions, rl, answers) ***REMOVED***
    super(questions, rl, answers);

    if (!this.opt.choices) ***REMOVED***
      this.throwParamError('choices');
    ***REMOVED***

    if (_.isArray(this.opt.default)) ***REMOVED***
      this.opt.choices.forEach(function(choice) ***REMOVED***
        if (this.opt.default.indexOf(choice.value) >= 0) ***REMOVED***
          choice.checked = true;
        ***REMOVED***
      ***REMOVED***, this);
    ***REMOVED***

    this.pointer = 0;

    // Make sure no default is set (so it won't be printed)
    this.opt.default = null;

    this.paginator = new Paginator(this.screen);
  ***REMOVED***

  /**
   * Start the Inquiry session
   * @param  ***REMOVED***Function***REMOVED*** cb      Callback when prompt is done
   * @return ***REMOVED***this***REMOVED***
   */

  _run(cb) ***REMOVED***
    this.done = cb;

    var events = observe(this.rl);

    var validation = this.handleSubmitEvents(
      events.line.pipe(map(this.getCurrentValue.bind(this)))
    );
    validation.success.forEach(this.onEnd.bind(this));
    validation.error.forEach(this.onError.bind(this));

    events.normalizedUpKey
      .pipe(takeUntil(validation.success))
      .forEach(this.onUpKey.bind(this));
    events.normalizedDownKey
      .pipe(takeUntil(validation.success))
      .forEach(this.onDownKey.bind(this));
    events.numberKey
      .pipe(takeUntil(validation.success))
      .forEach(this.onNumberKey.bind(this));
    events.spaceKey
      .pipe(takeUntil(validation.success))
      .forEach(this.onSpaceKey.bind(this));
    events.aKey.pipe(takeUntil(validation.success)).forEach(this.onAllKey.bind(this));
    events.iKey.pipe(takeUntil(validation.success)).forEach(this.onInverseKey.bind(this));

    // Init the prompt
    cliCursor.hide();
    this.render();
    this.firstRender = false;

    return this;
  ***REMOVED***

  /**
   * Render the prompt to screen
   * @return ***REMOVED***CheckboxPrompt***REMOVED*** self
   */

  render(error) ***REMOVED***
    // Render question
    var message = this.getQuestion();
    var bottomContent = '';

    if (!this.spaceKeyPressed) ***REMOVED***
      message +=
        '(Press ' +
        chalk.cyan.bold('<space>') +
        ' to select, ' +
        chalk.cyan.bold('<a>') +
        ' to toggle all, ' +
        chalk.cyan.bold('<i>') +
        ' to invert selection)';
    ***REMOVED***

    // Render choices or answer depending on the state
    if (this.status === 'answered') ***REMOVED***
      message += chalk.cyan(this.selection.join(', '));
    ***REMOVED*** else ***REMOVED***
      var choicesStr = renderChoices(this.opt.choices, this.pointer);
      var indexPosition = this.opt.choices.indexOf(
        this.opt.choices.getChoice(this.pointer)
      );
      message +=
        '\n' + this.paginator.paginate(choicesStr, indexPosition, this.opt.pageSize);
    ***REMOVED***

    if (error) ***REMOVED***
      bottomContent = chalk.red('>> ') + error;
    ***REMOVED***

    this.screen.render(message, bottomContent);
  ***REMOVED***

  /**
   * When user press `enter` key
   */

  onEnd(state) ***REMOVED***
    this.status = 'answered';

    // Rerender prompt (and clean subline error)
    this.render();

    this.screen.done();
    cliCursor.show();
    this.done(state.value);
  ***REMOVED***

  onError(state) ***REMOVED***
    this.render(state.isValid);
  ***REMOVED***

  getCurrentValue() ***REMOVED***
    var choices = this.opt.choices.filter(function(choice) ***REMOVED***
      return Boolean(choice.checked) && !choice.disabled;
    ***REMOVED***);

    this.selection = _.map(choices, 'short');
    return _.map(choices, 'value');
  ***REMOVED***

  onUpKey() ***REMOVED***
    var len = this.opt.choices.realLength;
    this.pointer = this.pointer > 0 ? this.pointer - 1 : len - 1;
    this.render();
  ***REMOVED***

  onDownKey() ***REMOVED***
    var len = this.opt.choices.realLength;
    this.pointer = this.pointer < len - 1 ? this.pointer + 1 : 0;
    this.render();
  ***REMOVED***

  onNumberKey(input) ***REMOVED***
    if (input <= this.opt.choices.realLength) ***REMOVED***
      this.pointer = input - 1;
      this.toggleChoice(this.pointer);
    ***REMOVED***

    this.render();
  ***REMOVED***

  onSpaceKey() ***REMOVED***
    this.spaceKeyPressed = true;
    this.toggleChoice(this.pointer);
    this.render();
  ***REMOVED***

  onAllKey() ***REMOVED***
    var shouldBeChecked = Boolean(
      this.opt.choices.find(function(choice) ***REMOVED***
        return choice.type !== 'separator' && !choice.checked;
      ***REMOVED***)
    );

    this.opt.choices.forEach(function(choice) ***REMOVED***
      if (choice.type !== 'separator') ***REMOVED***
        choice.checked = shouldBeChecked;
      ***REMOVED***
    ***REMOVED***);

    this.render();
  ***REMOVED***

  onInverseKey() ***REMOVED***
    this.opt.choices.forEach(function(choice) ***REMOVED***
      if (choice.type !== 'separator') ***REMOVED***
        choice.checked = !choice.checked;
      ***REMOVED***
    ***REMOVED***);

    this.render();
  ***REMOVED***

  toggleChoice(index) ***REMOVED***
    var item = this.opt.choices.getChoice(index);
    if (item !== undefined) ***REMOVED***
      this.opt.choices.getChoice(index).checked = !item.checked;
    ***REMOVED***
  ***REMOVED***
***REMOVED***

/**
 * Function for rendering checkbox choices
 * @param  ***REMOVED***Number***REMOVED*** pointer Position of the pointer
 * @return ***REMOVED***String***REMOVED***         Rendered content
 */

function renderChoices(choices, pointer) ***REMOVED***
  var output = '';
  var separatorOffset = 0;

  choices.forEach(function(choice, i) ***REMOVED***
    if (choice.type === 'separator') ***REMOVED***
      separatorOffset++;
      output += ' ' + choice + '\n';
      return;
    ***REMOVED***

    if (choice.disabled) ***REMOVED***
      separatorOffset++;
      output += ' - ' + choice.name;
      output += ' (' + (_.isString(choice.disabled) ? choice.disabled : 'Disabled') + ')';
    ***REMOVED*** else ***REMOVED***
      var line = getCheckbox(choice.checked) + ' ' + choice.name;
      if (i - separatorOffset === pointer) ***REMOVED***
        output += chalk.cyan(figures.pointer + line);
      ***REMOVED*** else ***REMOVED***
        output += ' ' + line;
      ***REMOVED***
    ***REMOVED***

    output += '\n';
  ***REMOVED***);

  return output.replace(/\n$/, '');
***REMOVED***

/**
 * Get the checkbox
 * @param  ***REMOVED***Boolean***REMOVED*** checked - add a X or not to the checkbox
 * @return ***REMOVED***String***REMOVED*** Composited checkbox string
 */

function getCheckbox(checked) ***REMOVED***
  return checked ? chalk.green(figures.radioOn) : figures.radioOff;
***REMOVED***

module.exports = CheckboxPrompt;
