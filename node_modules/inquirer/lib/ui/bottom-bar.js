'use strict';
/**
 * Sticky bottom bar user interface
 */

var through = require('through');
var Base = require('./baseUI');
var rlUtils = require('../utils/readline');
var _ = require('lodash');

class BottomBar extends Base ***REMOVED***
  constructor(opt) ***REMOVED***
    opt = opt || ***REMOVED******REMOVED***;

    super(opt);

    this.log = through(this.writeLog.bind(this));
    this.bottomBar = opt.bottomBar || '';
    this.render();
  ***REMOVED***

  /**
   * Render the prompt to screen
   * @return ***REMOVED***BottomBar***REMOVED*** self
   */

  render() ***REMOVED***
    this.write(this.bottomBar);
    return this;
  ***REMOVED***

  clean() ***REMOVED***
    rlUtils.clearLine(this.rl, this.bottomBar.split('\n').length);
    return this;
  ***REMOVED***

  /**
   * Update the bottom bar content and rerender
   * @param  ***REMOVED***String***REMOVED*** bottomBar Bottom bar content
   * @return ***REMOVED***BottomBar***REMOVED***           self
   */

  updateBottomBar(bottomBar) ***REMOVED***
    rlUtils.clearLine(this.rl, 1);
    this.rl.output.unmute();
    this.clean();
    this.bottomBar = bottomBar;
    this.render();
    this.rl.output.mute();
    return this;
  ***REMOVED***

  /**
   * Write out log data
   * @param ***REMOVED***String***REMOVED*** data - The log data to be output
   * @return ***REMOVED***BottomBar***REMOVED*** self
   */

  writeLog(data) ***REMOVED***
    this.rl.output.unmute();
    this.clean();
    this.rl.output.write(this.enforceLF(data.toString()));
    this.render();
    this.rl.output.mute();
    return this;
  ***REMOVED***

  /**
   * Make sure line end on a line feed
   * @param  ***REMOVED***String***REMOVED*** str Input string
   * @return ***REMOVED***String***REMOVED***     The input string with a final line feed
   */

  enforceLF(str) ***REMOVED***
    return str.match(/[\r\n]$/) ? str : str + '\n';
  ***REMOVED***

  /**
   * Helper for writing message in Prompt
   * @param ***REMOVED***BottomBar***REMOVED*** prompt  - The Prompt object that extends tty
   * @param ***REMOVED***String***REMOVED*** message - The message to be output
   */
  write(message) ***REMOVED***
    var msgLines = message.split(/\n/);
    this.height = msgLines.length;

    // Write message to screen and setPrompt to control backspace
    this.rl.setPrompt(_.last(msgLines));

    if (this.rl.output.rows === 0 && this.rl.output.columns === 0) ***REMOVED***
      /* When it's a tty through serial port there's no terminal info and the render will malfunction,
         so we need enforce the cursor to locate to the leftmost position for rendering. */
      rlUtils.left(this.rl, message.length + this.rl.line.length);
    ***REMOVED***

    this.rl.output.write(message);
  ***REMOVED***
***REMOVED***

module.exports = BottomBar;
