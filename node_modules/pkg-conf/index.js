'use strict';
const path = require('path');
const findUp = require('find-up');
const loadJsonFile = require('load-json-file');

const filepaths = new WeakMap();
const filepath = conf => filepaths.get(conf);
const findNextCwd = pkgPath => path.resolve(path.dirname(pkgPath), '..');

const addFilePath = (object, filePath) => ***REMOVED***
	filepaths.set(object, filePath);
	return object;
***REMOVED***;

const pkgConf = (namespace, options = ***REMOVED******REMOVED***) => ***REMOVED***
	if (!namespace) ***REMOVED***
		return Promise.reject(new TypeError('Expected a namespace'));
	***REMOVED***

	return findUp('package.json', options.cwd ? ***REMOVED***cwd: options.cwd***REMOVED*** : ***REMOVED******REMOVED***)
		.then(filePath => ***REMOVED***
			if (!filePath) ***REMOVED***
				return addFilePath(Object.assign(***REMOVED******REMOVED***, options.defaults), filePath);
			***REMOVED***

			return loadJsonFile(filePath).then(package_ => ***REMOVED***
				if (options.skipOnFalse && package_[namespace] === false) ***REMOVED***
					const newOptions = Object.assign(***REMOVED******REMOVED***, options, ***REMOVED***cwd: findNextCwd(filePath)***REMOVED***);
					return pkgConf(namespace, newOptions);
				***REMOVED***

				return addFilePath(Object.assign(***REMOVED******REMOVED***, options.defaults, package_[namespace]), filePath);
			***REMOVED***);
		***REMOVED***);
***REMOVED***;

const sync = (namespace, options = ***REMOVED******REMOVED***) => ***REMOVED***
	if (!namespace) ***REMOVED***
		throw new TypeError('Expected a namespace');
	***REMOVED***

	const filePath = findUp.sync('package.json', options.cwd ? ***REMOVED***cwd: options.cwd***REMOVED*** : ***REMOVED******REMOVED***);

	if (!filePath) ***REMOVED***
		return addFilePath(Object.assign(***REMOVED******REMOVED***, options.defaults), filePath);
	***REMOVED***

	const package_ = loadJsonFile.sync(filePath);

	if (options.skipOnFalse && package_[namespace] === false) ***REMOVED***
		const newOptions = Object.assign(***REMOVED******REMOVED***, options, ***REMOVED***cwd: findNextCwd(filePath)***REMOVED***);
		return sync(namespace, newOptions);
	***REMOVED***

	return addFilePath(Object.assign(***REMOVED******REMOVED***, options.defaults, package_[namespace]), filePath);
***REMOVED***;

module.exports = pkgConf;
// TODO: Remove this for the next major release
module.exports.default = pkgConf;
module.exports.filepath = filepath;
module.exports.sync = sync;
