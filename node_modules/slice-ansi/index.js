'use strict';
const isFullwidthCodePoint = require('is-fullwidth-code-point');
const astralRegex = require('astral-regex');
const ansiStyles = require('ansi-styles');

const ESCAPES = [
	'\u001B',
	'\u009B'
];

const END_CODE = 39;

const wrapAnsi = code => `$***REMOVED***ESCAPES[0]***REMOVED***[$***REMOVED***code***REMOVED***m`;

module.exports = (str, begin, end) => ***REMOVED***
	const arr = [...str.normalize()];

	end = typeof end === 'number' ? end : arr.length;

	let insideEscape = false;
	let escapeCode = null;
	let visible = 0;
	let output = '';

	for (const [i, x] of arr.entries()) ***REMOVED***
		let leftEscape = false;

		if (ESCAPES.includes(x)) ***REMOVED***
			insideEscape = true;
			const code = /\d[^m]*/.exec(str.slice(i, i + 18));
			escapeCode = code === END_CODE ? null : code;
		***REMOVED*** else if (insideEscape && x === 'm') ***REMOVED***
			insideEscape = false;
			leftEscape = true;
		***REMOVED***

		if (!insideEscape && !leftEscape) ***REMOVED***
			++visible;
		***REMOVED***

		if (!astralRegex(***REMOVED***exact: true***REMOVED***).test(x) && isFullwidthCodePoint(x.codePointAt())) ***REMOVED***
			++visible;
		***REMOVED***

		if (visible > begin && visible <= end) ***REMOVED***
			output += x;
		***REMOVED*** else if (visible === begin && !insideEscape && escapeCode !== null && escapeCode !== END_CODE) ***REMOVED***
			output += wrapAnsi(escapeCode);
		***REMOVED*** else if (visible >= end) ***REMOVED***
			if (escapeCode !== null) ***REMOVED***
				output += wrapAnsi(ansiStyles.codes.get(parseInt(escapeCode, 10)) || END_CODE);
			***REMOVED***

			break;
		***REMOVED***
	***REMOVED***

	return output;
***REMOVED***;
