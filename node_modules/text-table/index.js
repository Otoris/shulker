module.exports = function (rows_, opts) ***REMOVED***
    if (!opts) opts = ***REMOVED******REMOVED***;
    var hsep = opts.hsep === undefined ? '  ' : opts.hsep;
    var align = opts.align || [];
    var stringLength = opts.stringLength
        || function (s) ***REMOVED*** return String(s).length; ***REMOVED***
    ;
    
    var dotsizes = reduce(rows_, function (acc, row) ***REMOVED***
        forEach(row, function (c, ix) ***REMOVED***
            var n = dotindex(c);
            if (!acc[ix] || n > acc[ix]) acc[ix] = n;
        ***REMOVED***);
        return acc;
    ***REMOVED***, []);
    
    var rows = map(rows_, function (row) ***REMOVED***
        return map(row, function (c_, ix) ***REMOVED***
            var c = String(c_);
            if (align[ix] === '.') ***REMOVED***
                var index = dotindex(c);
                var size = dotsizes[ix] + (/\./.test(c) ? 1 : 2)
                    - (stringLength(c) - index)
                ;
                return c + Array(size).join(' ');
            ***REMOVED***
            else return c;
        ***REMOVED***);
    ***REMOVED***);
    
    var sizes = reduce(rows, function (acc, row) ***REMOVED***
        forEach(row, function (c, ix) ***REMOVED***
            var n = stringLength(c);
            if (!acc[ix] || n > acc[ix]) acc[ix] = n;
        ***REMOVED***);
        return acc;
    ***REMOVED***, []);
    
    return map(rows, function (row) ***REMOVED***
        return map(row, function (c, ix) ***REMOVED***
            var n = (sizes[ix] - stringLength(c)) || 0;
            var s = Array(Math.max(n + 1, 1)).join(' ');
            if (align[ix] === 'r' || align[ix] === '.') ***REMOVED***
                return s + c;
            ***REMOVED***
            if (align[ix] === 'c') ***REMOVED***
                return Array(Math.ceil(n / 2 + 1)).join(' ')
                    + c + Array(Math.floor(n / 2 + 1)).join(' ')
                ;
            ***REMOVED***
            
            return c + s;
        ***REMOVED***).join(hsep).replace(/\s+$/, '');
    ***REMOVED***).join('\n');
***REMOVED***;

function dotindex (c) ***REMOVED***
    var m = /\.[^.]*$/.exec(c);
    return m ? m.index + 1 : c.length;
***REMOVED***

function reduce (xs, f, init) ***REMOVED***
    if (xs.reduce) return xs.reduce(f, init);
    var i = 0;
    var acc = arguments.length >= 3 ? init : xs[i++];
    for (; i < xs.length; i++) ***REMOVED***
        f(acc, xs[i], i);
    ***REMOVED***
    return acc;
***REMOVED***

function forEach (xs, f) ***REMOVED***
    if (xs.forEach) return xs.forEach(f);
    for (var i = 0; i < xs.length; i++) ***REMOVED***
        f.call(xs, xs[i], i);
    ***REMOVED***
***REMOVED***

function map (xs, f) ***REMOVED***
    if (xs.map) return xs.map(f);
    var res = [];
    for (var i = 0; i < xs.length; i++) ***REMOVED***
        res.push(f.call(xs, xs[i], i));
    ***REMOVED***
    return res;
***REMOVED***
