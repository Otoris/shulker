/**
 * @author Toru Nagashima
 * See LICENSE file in root directory for full license.
 */
"use strict"

const fs = require("fs")
const path = require("path")
const Cache = require("./cache")

const cache = new Cache()

/**
 * Reads the `package.json` data in a given path.
 *
 * Don't cache the data.
 *
 * @param ***REMOVED***string***REMOVED*** dir - The path to a directory to read.
 * @returns ***REMOVED***object|null***REMOVED*** The read `package.json` data, or null.
 */
function readPackageJson(dir) ***REMOVED***
    const filePath = path.join(dir, "package.json")
    try ***REMOVED***
        const text = fs.readFileSync(filePath, "utf8")
        const data = JSON.parse(text)

        if (typeof data === "object" && data !== null) ***REMOVED***
            data.filePath = filePath
            return data
        ***REMOVED***
    ***REMOVED*** catch (_err) ***REMOVED***
        // do nothing.
    ***REMOVED***

    return null
***REMOVED***

/**
 * Gets a `package.json` data.
 * The data is cached if found, then it's used after.
 *
 * @param ***REMOVED***string***REMOVED*** [startPath] - A file path to lookup.
 * @returns ***REMOVED***object|null***REMOVED*** A found `package.json` data or `null`.
 *      This object have additional property `filePath`.
 */
module.exports = function getPackageJson(startPath = "a.js") ***REMOVED***
    const startDir = path.dirname(path.resolve(startPath))
    let dir = startDir
    let prevDir = ""
    let data = null

    do ***REMOVED***
        data = cache.get(dir)
        if (data) ***REMOVED***
            if (dir !== startDir) ***REMOVED***
                cache.set(startDir, data)
            ***REMOVED***
            return data
        ***REMOVED***

        data = readPackageJson(dir)
        if (data) ***REMOVED***
            cache.set(dir, data)
            cache.set(startDir, data)
            return data
        ***REMOVED***

        // Go to next.
        prevDir = dir
        dir = path.resolve(dir, "..")
    ***REMOVED*** while (dir !== prevDir)

    cache.set(startDir, null)
    return null
***REMOVED***
